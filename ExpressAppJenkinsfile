pipeline {
    agent any
    
    environment {
        NODE_VERSION = '18'
        APP_NAME = 'express-app'
        DOCKER_IMAGE = "${APP_NAME}:${BUILD_NUMBER}"
    }

    stages {
        stage('ğŸ” Checkout') {
            steps {
                echo "=== CHECKING OUT SOURCE CODE ==="
                checkout scm
                echo "âœ… Source code checked out successfully"
            }
        }
        
        stage('ğŸ”§ Setup Node.js') {
            steps {
                echo "=== SETTING UP NODE.JS ENVIRONMENT ==="
                sh '''
                    echo "ğŸ“‹ Node.js version check:"
                    node --version
                    echo "ğŸ“¦ NPM version check:"
                    npm --version
                '''
            }
        }
        
        stage('ğŸ“¦ Install Dependencies') {
            steps {
                echo "=== INSTALLING DEPENDENCIES ==="
                dir('appserver') {
                    sh '''
                        echo "ğŸ” Checking package.json..."
                        if [ -f package.json ]; then
                            echo "ğŸ“¥ Installing npm packages..."
                            npm ci --only=production
                            echo "âœ… Dependencies installed successfully"
                        else
                            echo "âŒ No package.json found"
                            exit 1
                        fi
                    '''
                }
            }
        }
        
        stage('ğŸ§ª Run Tests') {
            steps {
                echo "=== RUNNING TESTS ==="
                dir('appserver') {
                    script {
                        try {
                            sh 'npm test'
                            echo "âœ… All tests passed"
                        } catch (Exception e) {
                            echo "âš ï¸ No tests found or tests failed, continuing..."
                        }
                    }
                }
            }
        }
        
        stage('ğŸ” Code Quality Check') {
            steps {
                echo "=== CODE QUALITY ANALYSIS ==="
                dir('appserver') {
                    sh '''
                        echo "ğŸ“Š Checking file structure..."
                        ls -la
                        echo "ğŸ” Checking server.js syntax..."
                        node -c server.js
                        echo "âœ… Code quality check passed"
                    '''
                }
            }
        }
        
        stage('ğŸ³ Build Docker Image') {
            steps {
                echo "=== BUILDING DOCKER IMAGE ==="
                dir('appserver') {
                    script {
                        try {
                            sh """
                                echo "ğŸ—ï¸ Building Docker image: ${DOCKER_IMAGE}"
                                docker build -t ${DOCKER_IMAGE} .
                                echo "âœ… Docker image built successfully"
                                
                                echo "ğŸ“‹ Docker images:"
                                docker images | grep ${APP_NAME}
                            """
                        } catch (Exception e) {
                            echo "âš ï¸ Docker not available, skipping Docker build"
                        }
                    }
                }
            }
        }
        
        stage('ğŸš€ Deploy Application') {
            steps {
                echo "=== DEPLOYING APPLICATION ==="
                dir('appserver') {
                    script {
                        sh '''
                            echo "ğŸ¯ Starting deployment process..."
                            
                            # Stop any existing process on port 3000
                            echo "ğŸ›‘ Stopping existing services..."
                            pkill -f "node server.js" || true
                            
                            # Wait a moment for cleanup
                            sleep 2
                            
                            echo "ğŸš€ Starting Express application..."
                            nohup node server.js > app.log 2>&1 &
                            
                            # Give the app time to start
                            sleep 3
                            
                            echo "ğŸ” Checking if application is running..."
                            if curl -f http://localhost:3000 > /dev/null 2>&1; then
                                echo "âœ… Application deployed successfully!"
                                echo "ğŸŒ Application is running at: http://localhost:3000"
                            else
                                echo "âŒ Application failed to start"
                                echo "ğŸ“„ Application logs:"
                                cat app.log || echo "No logs available"
                                exit 1
                            fi
                        '''
                    }
                }
            }
        }
        
        stage('âœ… Health Check') {
            steps {
                echo "=== PERFORMING HEALTH CHECK ==="
                dir('appserver') {
                    sh '''
                        echo "ğŸ¥ Running health checks..."
                        
                        echo "ğŸ” Testing application endpoint..."
                        response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000)
                        
                        if [ "$response" = "200" ]; then
                            echo "âœ… Health check passed - Application is responding"
                            echo "ğŸ“Š Application status: HEALTHY"
                        else
                            echo "âŒ Health check failed - HTTP status: $response"
                            exit 1
                        fi
                        
                        echo "ğŸ“ˆ Performance check..."
                        time curl -s http://localhost:3000 > /dev/null
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo "ğŸ === PIPELINE EXECUTION COMPLETED ==="
            echo "ğŸ“Š Build Number: ${BUILD_NUMBER}"
            echo "ğŸ• Build Duration: ${currentBuild.durationString}"
        }
        
        success {
            echo "ğŸ‰ === PIPELINE SUCCEEDED ==="
            echo "âœ… Express application deployed successfully!"
            echo "ğŸŒ Application URL: http://localhost:3000"
        }
        
        failure {
            echo "ğŸ’¥ === PIPELINE FAILED ==="
            echo "âŒ Deployment failed. Check the logs above for details."
            dir('appserver') {
                script {
                    try {
                        sh '''
                            echo "ğŸ“„ Application logs (last 20 lines):"
                            tail -20 app.log || echo "No application logs available"
                        '''
                    } catch (Exception e) {
                        echo "Could not retrieve application logs"
                    }
                }
            }
        }
        
        cleanup {
            echo "ğŸ§¹ === CLEANING UP ==="
            sh '''
                echo "ğŸ—‘ï¸ Cleaning up temporary files..."
                # Add any cleanup commands here if needed
            '''
        }
    }
}
