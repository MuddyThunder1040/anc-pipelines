pipeline {
    agent any
    
    parameters {
        choice(
            name: 'ACTION',
            choices: ['start', 'stop', 'restart', 'status'],
            description: 'Select the action to perform on Docker containers'
        )
        choice(
            name: 'CONTAINER_TARGET',
            choices: ['all', 'express-app', 'specific'],
            description: 'Select which containers to manage'
        )
        string(
            name: 'SPECIFIC_CONTAINER',
            defaultValue: '',
            description: 'Enter specific container name/ID (only used when CONTAINER_TARGET is "specific")'
        )
        booleanParam(
            name: 'FORCE_REMOVE',
            defaultValue: false,
            description: 'Force remove containers when stopping (use with caution)'
        )
        choice(
            name: 'IMAGE_ACTION',
            choices: ['none', 'pull-latest', 'rebuild'],
            description: 'Additional image actions to perform'
        )
    }
    
    environment {
        DOCKER_HUB_REPO = 'muddythunder/express-app'
        DOCKER_HUB_CREDENTIALS = 'c71d37ab-7559-4e0e-a3ea-fcf087717f4e'
        APP_NAME = 'express-app'
        CONTAINER_NAME = "${APP_NAME}-container"
    }

    stages {
        stage('ğŸ” Docker Environment Check') {
            steps {
                echo "=== CHECKING DOCKER ENVIRONMENT ==="
                script {
                    sh '''
                        echo "ğŸ³ Docker version:"
                        docker --version
                        
                        echo "ğŸ“Š Docker system info:"
                        docker info | head -20
                        
                        echo "ğŸ“‹ Current Docker containers:"
                        docker ps -a --format "table {{.Names}}\\t{{.Image}}\\t{{.Status}}\\t{{.Ports}}"
                        
                        echo "ğŸ–¼ï¸ Available Docker images:"
                        docker images --format "table {{.Repository}}\\t{{.Tag}}\\t{{.Size}}\\t{{.CreatedAt}}"
                    '''
                }
            }
        }
        
        stage('ğŸ”„ Image Management') {
            when {
                not { 
                    equals expected: 'none', actual: params.IMAGE_ACTION 
                }
            }
            steps {
                echo "=== MANAGING DOCKER IMAGES ==="
                script {
                    if (params.IMAGE_ACTION == 'pull-latest') {
                        withCredentials([usernamePassword(credentialsId: env.DOCKER_HUB_CREDENTIALS, 
                                                        usernameVariable: 'DOCKER_USERNAME', 
                                                        passwordVariable: 'DOCKER_PASSWORD')]) {
                            sh '''
                                echo "ğŸ” Logging into Docker Hub..."
                                echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
                                
                                echo "ğŸ“¥ Pulling latest image from Docker Hub..."
                                docker pull ${DOCKER_HUB_REPO}:latest
                                
                                echo "ğŸ§¹ Logging out from Docker Hub..."
                                docker logout
                            '''
                        }
                    } else if (params.IMAGE_ACTION == 'rebuild') {
                        sh '''
                            echo "ğŸ—ï¸ Rebuilding Docker image from source..."
                            if [ -f Dockerfile ]; then
                                docker build -t ${DOCKER_HUB_REPO}:latest .
                                echo "âœ… Image rebuilt successfully"
                            else
                                echo "âŒ No Dockerfile found in current directory"
                                exit 1
                            fi
                        '''
                    }
                }
            }
        }
        
        stage('ğŸ©º Container Health Diagnostics') {
            when {
                anyOf {
                    equals expected: 'start', actual: params.ACTION
                    equals expected: 'restart', actual: params.ACTION
                    equals expected: 'status', actual: params.ACTION
                }
            }
            steps {
                echo "=== RUNNING CONTAINER DIAGNOSTICS ==="
                script {
                    sh '''
                        echo "ğŸ” Checking for problematic containers (exit code 139)..."
                        PROBLEM_CONTAINERS=$(docker ps -a --filter "status=exited" --format "{{.Names}}: {{.Status}}" | grep "139" || true)
                        
                        if [ -n "$PROBLEM_CONTAINERS" ]; then
                            echo "âš ï¸ Found containers with exit code 139 (segmentation fault):"
                            echo "$PROBLEM_CONTAINERS"
                            
                            echo "ğŸ§¹ Cleaning up problematic containers..."
                            docker ps -a --filter "status=exited" --format "{{.Names}}" | while read container; do
                                if docker ps -a --filter "name=$container" --format "{{.Status}}" | grep -q "139"; then
                                    echo "ğŸ—‘ï¸ Removing problematic container: $container"
                                    docker rm "$container" 2>/dev/null || true
                                fi
                            done
                        else
                            echo "âœ… No containers with exit code 139 found"
                        fi
                        
                        echo "ğŸ“Š Docker system prune (cleanup unused resources):"
                        docker system prune -f --volumes || true
                        
                        echo "ğŸ” Checking Docker daemon status:"
                        docker info | grep -E "(Server Version|Storage Driver|Logging Driver|Cgroup Driver)" || true
                    '''
                }
            }
        }
        
        stage('ğŸš€ Container Management') {
            steps {
                echo "=== PERFORMING CONTAINER MANAGEMENT ==="
                script {
                    def containerTarget = params.CONTAINER_TARGET
                    def action = params.ACTION
                    def specificContainer = params.SPECIFIC_CONTAINER
                    def forceRemove = params.FORCE_REMOVE
                    
                    switch(action) {
                        case 'start':
                            startContainers(containerTarget, specificContainer)
                            break
                        case 'stop':
                            stopContainers(containerTarget, specificContainer, forceRemove)
                            break
                        case 'restart':
                            restartContainers(containerTarget, specificContainer)
                            break
                        case 'status':
                            checkContainerStatus(containerTarget, specificContainer)
                            break
                        default:
                            error "Unknown action: ${action}"
                    }
                }
            }
        }
        
        stage('ğŸ” Post-Action Verification') {
            steps {
                echo "=== VERIFYING CONTAINER STATES ==="
                script {
                    sh '''
                        echo "ğŸ“Š Current container status:"
                        docker ps -a --format "table {{.Names}}\\t{{.Image}}\\t{{.Status}}\\t{{.Ports}}"
                        
                        echo "ğŸ’¾ System resource usage:"
                        docker system df
                        
                        echo "ğŸ–¥ï¸ Host system resources:"
                        echo "Memory usage:"
                        free -h || echo "free command not available"
                        echo "Disk usage:"
                        df -h / || echo "df command not available"
                        
                        if [ "${ACTION}" = "start" ]; then
                            echo "ğŸ” Testing running containers..."
                            
                            # Check if express-app container is running and accessible
                            if docker ps --filter "name=${CONTAINER_NAME}" --filter "status=running" | grep -q "${CONTAINER_NAME}"; then
                                echo "âœ… Express app container is running"
                                
                                # Get detailed container information
                                echo "ğŸ” Container detailed status:"
                                docker inspect ${CONTAINER_NAME} --format "Status: {{.State.Status}}, ExitCode: {{.State.ExitCode}}, Error: {{.State.Error}}"
                                
                                # Get the port mapping
                                CONTAINER_PORT=$(docker port ${CONTAINER_NAME} 3000 2>/dev/null | head -1 || echo "Port mapping not found")
                                echo "ğŸŒ Port mapping: ${CONTAINER_PORT}"
                                
                                # Show recent logs
                                echo "ğŸ“„ Recent container logs:"
                                docker logs ${CONTAINER_NAME} --tail 20 || echo "No logs available"
                                
                                # Try to access the health endpoint if port is mapped
                                if echo "$CONTAINER_PORT" | grep -q ":"; then
                                    HOST_PORT=$(echo $CONTAINER_PORT | grep -o '[0-9]*$' | head -1)
                                    echo "ğŸ¥ Testing health endpoint on port $HOST_PORT..."
                                    
                                    max_attempts=3
                                    attempt=1
                                    
                                    while [ $attempt -le $max_attempts ]; do
                                        if curl -f http://localhost:$HOST_PORT/health > /dev/null 2>&1; then
                                            echo "âœ… Application health check passed on port $HOST_PORT"
                                            break
                                        else
                                            if [ $attempt -eq $max_attempts ]; then
                                                echo "âš ï¸ Health check failed after $max_attempts attempts"
                                                echo "ğŸ” Testing basic connectivity:"
                                                curl -v http://localhost:$HOST_PORT 2>&1 | head -10 || echo "Connection failed"
                                            else
                                                echo "âš ï¸ Health check attempt $attempt failed, retrying..."
                                                sleep 2
                                            fi
                                        fi
                                        attempt=$((attempt + 1))
                                    done
                                fi
                            else
                                echo "â„¹ï¸ Express app container not running or not found"
                                echo "ğŸ” Checking if container exited:"
                                if docker ps -a --filter "name=${CONTAINER_NAME}" | grep -q "${CONTAINER_NAME}"; then
                                    echo "ğŸ“„ Container logs (last 50 lines):"
                                    docker logs ${CONTAINER_NAME} --tail 50 || echo "No logs available"
                                    echo "ğŸ” Container exit details:"
                                    docker inspect ${CONTAINER_NAME} --format "Status: {{.State.Status}}, ExitCode: {{.State.ExitCode}}, Error: {{.State.Error}}, StartedAt: {{.State.StartedAt}}, FinishedAt: {{.State.FinishedAt}}"
                                fi
                            fi
                            
                            echo "ğŸ”„ Checking all container statuses for exit code 139 issues:"
                            docker ps -a --filter "status=exited" --format "{{.Names}}: {{.Status}}" | grep "139" || echo "No containers with exit code 139 found"
                        fi
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo "ğŸ === DOCKER MANAGEMENT COMPLETED ==="
            echo "ğŸ“Š Action performed: ${params.ACTION}"
            echo "ğŸ¯ Target: ${params.CONTAINER_TARGET}"
            script {
                if (params.CONTAINER_TARGET == 'specific' && params.SPECIFIC_CONTAINER) {
                    echo "ğŸ“ Specific container: ${params.SPECIFIC_CONTAINER}"
                }
            }
        }
        
        success {
            echo "ğŸ‰ === DOCKER MANAGEMENT SUCCEEDED ==="
            script {
                sh '''
                    echo "ğŸ“‹ Final container summary:"
                    docker ps -a --format "table {{.Names}}\\t{{.Image}}\\t{{.Status}}\\t{{.Ports}}" | head -10
                '''
            }
        }
        
        failure {
            echo "ğŸ’¥ === DOCKER MANAGEMENT FAILED ==="
            echo "âŒ Check the logs above for details"
            script {
                try {
                    sh '''
                        echo "ğŸ” Docker system diagnostics:"
                        docker system events --since 5m --until now || true
                        
                        echo "ğŸ“„ Docker daemon logs (if accessible):"
                        docker system info | grep -A 5 -B 5 "ERROR\\|WARN" || true
                        
                        echo "ğŸ©º Container exit diagnostics:"
                        docker ps -a --filter "status=exited" --format "table {{.Names}}\\t{{.Status}}\\t{{.Image}}"
                        
                        echo "ğŸ“Š System resource check:"
                        echo "Memory:"
                        free -h 2>/dev/null || echo "Memory info not available"
                        echo "Disk space:"
                        df -h / 2>/dev/null || echo "Disk info not available"
                        
                        echo "ğŸ” Recent container logs for failed containers:"
                        docker ps -a --filter "status=exited" --format "{{.Names}}" | head -3 | while read container; do
                            echo "--- Logs for $container ---"
                            docker logs "$container" --tail 10 2>/dev/null || echo "No logs for $container"
                        done
                        
                        echo "ğŸ§¹ Cleanup recommendations:"
                        echo "- Consider running: docker system prune -f"
                        echo "- Check available disk space"
                        echo "- Restart Docker daemon if issues persist"
                    '''
                } catch (Exception e) {
                    echo "Could not retrieve Docker diagnostics: ${e.getMessage()}"
                }
            }
        }
    }
}

// Helper function to start containers
def startContainers(containerTarget, specificContainer) {
    switch(containerTarget) {
        case 'all':
            sh '''
                echo "ğŸš€ Starting all stopped containers..."
                STOPPED_CONTAINERS=$(docker ps -aq --filter "status=exited")
                
                if [ -n "$STOPPED_CONTAINERS" ]; then
                    echo "ğŸ“‹ Found stopped containers:"
                    docker ps -a --filter "status=exited" --format "table {{.Names}}\\t{{.Image}}\\t{{.Status}}"
                    
                    echo "â–¶ï¸ Starting containers..."
                    docker start $STOPPED_CONTAINERS
                    
                    echo "âœ… All stopped containers started"
                else
                    echo "â„¹ï¸ No stopped containers found"
                fi
            '''
            break
            
        case 'express-app':
            sh '''
                echo "ğŸš€ Managing Express app container..."
                
                # First, clean up any existing containers with the same name
                if docker ps -a --filter "name=${CONTAINER_NAME}" | grep -q "${CONTAINER_NAME}"; then
                    echo "ğŸ§¹ Cleaning up existing container..."
                    docker stop ${CONTAINER_NAME} 2>/dev/null || true
                    docker rm ${CONTAINER_NAME} 2>/dev/null || true
                    echo "âœ… Existing container cleaned up"
                fi
                
                # Check if image exists
                if ! docker images ${DOCKER_HUB_REPO}:latest | grep -q "${DOCKER_HUB_REPO}"; then
                    echo "âŒ Image ${DOCKER_HUB_REPO}:latest not found locally"
                    echo "ğŸ“¥ Attempting to pull image..."
                    docker pull ${DOCKER_HUB_REPO}:latest || {
                        echo "âŒ Failed to pull image. Check if image exists in registry."
                        exit 1
                    }
                fi
                
                echo "ğŸ—ï¸ Creating new Express app container with enhanced configuration..."
                
                # Stop any container using port 3001
                EXISTING_PORT_CONTAINER=$(docker ps -q --filter "publish=3001" 2>/dev/null)
                if [ -n "$EXISTING_PORT_CONTAINER" ]; then
                    echo "ğŸ›‘ Stopping container using port 3001..."
                    docker stop $EXISTING_PORT_CONTAINER 2>/dev/null || true
                fi
                
                # Create container with restart policy and resource limits
                docker run -d \\
                    --name ${CONTAINER_NAME} \\
                    -p 3001:3000 \\
                    --restart=unless-stopped \\
                    --memory=512m \\
                    --memory-swap=1g \\
                    --cpus=1.0 \\
                    --health-cmd="curl -f http://localhost:3000/health || exit 1" \\
                    --health-interval=30s \\
                    --health-timeout=10s \\
                    --health-retries=3 \\
                    --health-start-period=40s \\
                    ${DOCKER_HUB_REPO}:latest
                
                # Wait a moment for container to start
                echo "â³ Waiting for container to initialize..."
                sleep 5
                
                # Check if container is running
                if docker ps --filter "name=${CONTAINER_NAME}" --filter "status=running" | grep -q "${CONTAINER_NAME}"; then
                    echo "âœ… New Express app container created and started on port 3001"
                    echo "ğŸ“‹ Container status:"
                    docker ps --filter "name=${CONTAINER_NAME}" --format "table {{.Names}}\\t{{.Status}}\\t{{.Ports}}"
                else
                    echo "âŒ Container failed to start. Checking logs..."
                    docker logs ${CONTAINER_NAME} --tail 20 || echo "No logs available"
                    echo "ğŸ” Container details:"
                    docker inspect ${CONTAINER_NAME} --format "Status: {{.State.Status}}, ExitCode: {{.State.ExitCode}}, Error: {{.State.Error}}"
                    exit 1
                fi
            '''
            break
            
        case 'specific':
            if (!specificContainer) {
                error "Specific container name must be provided when CONTAINER_TARGET is 'specific'"
            }
            sh """
                echo "ğŸš€ Starting specific container: ${specificContainer}"
                
                if docker ps -a --filter "name=${specificContainer}" | grep -q "${specificContainer}"; then
                    docker start ${specificContainer}
                    echo "âœ… Container '${specificContainer}' started"
                else
                    echo "âŒ Container '${specificContainer}' not found"
                    exit 1
                fi
            """
            break
            
        default:
            error "Unknown container target: ${containerTarget}"
    }
}

// Helper function to stop containers
def stopContainers(containerTarget, specificContainer, forceRemove) {
    switch(containerTarget) {
        case 'all':
            sh """
                echo "ğŸ›‘ Stopping all running containers..."
                RUNNING_CONTAINERS=\$(docker ps -q)
                
                if [ -n "\$RUNNING_CONTAINERS" ]; then
                    echo "ğŸ“‹ Found running containers:"
                    docker ps --format "table {{.Names}}\\t{{.Image}}\\t{{.Status}}"
                    
                    echo "â¹ï¸ Stopping containers..."
                    docker stop \$RUNNING_CONTAINERS
                    
                    if [ "${forceRemove}" = "true" ]; then
                        echo "ğŸ—‘ï¸ Force removing containers..."
                        docker rm \$RUNNING_CONTAINERS
                        echo "âœ… All containers stopped and removed"
                    else
                        echo "âœ… All containers stopped"
                    fi
                else
                    echo "â„¹ï¸ No running containers found"
                fi
            """
            break
            
        case 'express-app':
            sh """
                echo "ğŸ›‘ Stopping Express app container..."
                
                if docker ps --filter "name=${CONTAINER_NAME}" | grep -q "${CONTAINER_NAME}"; then
                    docker stop ${CONTAINER_NAME}
                    echo "âœ… Express app container stopped"
                    
                    if [ "${forceRemove}" = "true" ]; then
                        docker rm ${CONTAINER_NAME}
                        echo "ğŸ—‘ï¸ Express app container removed"
                    fi
                else
                    echo "â„¹ï¸ Express app container not running"
                fi
            """
            break
            
        case 'specific':
            if (!specificContainer) {
                error "Specific container name must be provided when CONTAINER_TARGET is 'specific'"
            }
            sh """
                echo "ğŸ›‘ Stopping specific container: ${specificContainer}"
                
                if docker ps --filter "name=${specificContainer}" | grep -q "${specificContainer}"; then
                    docker stop ${specificContainer}
                    echo "âœ… Container '${specificContainer}' stopped"
                    
                    if [ "${forceRemove}" = "true" ]; then
                        docker rm ${specificContainer}
                        echo "ğŸ—‘ï¸ Container '${specificContainer}' removed"
                    fi
                else
                    echo "â„¹ï¸ Container '${specificContainer}' not running"
                fi
            """
            break
            
        default:
            error "Unknown container target: ${containerTarget}"
    }
}

// Helper function to restart containers
def restartContainers(containerTarget, specificContainer) {
    switch(containerTarget) {
        case 'all':
            sh '''
                echo "ğŸ”„ Restarting all containers..."
                ALL_CONTAINERS=$(docker ps -aq)
                
                if [ -n "$ALL_CONTAINERS" ]; then
                    echo "ğŸ“‹ Found containers:"
                    docker ps -a --format "table {{.Names}}\\t{{.Image}}\\t{{.Status}}"
                    
                    echo "ğŸ”„ Restarting containers..."
                    docker restart $ALL_CONTAINERS
                    echo "âœ… All containers restarted"
                else
                    echo "â„¹ï¸ No containers found"
                fi
            '''
            break
            
        case 'express-app':
            sh '''
                echo "ğŸ”„ Restarting Express app container..."
                
                if docker ps -a --filter "name=${CONTAINER_NAME}" | grep -q "${CONTAINER_NAME}"; then
                    docker restart ${CONTAINER_NAME}
                    echo "âœ… Express app container restarted"
                else
                    echo "âŒ Express app container not found"
                    exit 1
                fi
            '''
            break
            
        case 'specific':
            if (!specificContainer) {
                error "Specific container name must be provided when CONTAINER_TARGET is 'specific'"
            }
            sh """
                echo "ğŸ”„ Restarting specific container: ${specificContainer}"
                
                if docker ps -a --filter "name=${specificContainer}" | grep -q "${specificContainer}"; then
                    docker restart ${specificContainer}
                    echo "âœ… Container '${specificContainer}' restarted"
                else
                    echo "âŒ Container '${specificContainer}' not found"
                    exit 1
                fi
            """
            break
            
        default:
            error "Unknown container target: ${containerTarget}"
    }
}

// Helper function to check container status
def checkContainerStatus(containerTarget, specificContainer) {
    switch(containerTarget) {
        case 'all':
            sh '''
                echo "ğŸ“Š Checking status of all containers..."
                
                echo "ğŸ” All containers (running and stopped):"
                docker ps -a --format "table {{.Names}}\\t{{.Image}}\\t{{.Status}}\\t{{.Ports}}\\t{{.Size}}"
                
                echo "ğŸ“ˆ Running containers only:"
                docker ps --format "table {{.Names}}\\t{{.Image}}\\t{{.Status}}\\t{{.Ports}}"
                
                echo "ğŸ’¾ Container resource usage:"
                docker stats --no-stream --format "table {{.Container}}\\t{{.CPUPerc}}\\t{{.MemUsage}}\\t{{.NetIO}}"
            '''
            break
            
        case 'express-app':
            sh '''
                echo "ğŸ“Š Checking Express app container status..."
                
                if docker ps -a --filter "name=${CONTAINER_NAME}" | grep -q "${CONTAINER_NAME}"; then
                    echo "ğŸ“‹ Container details:"
                    docker ps -a --filter "name=${CONTAINER_NAME}" --format "table {{.Names}}\\t{{.Image}}\\t{{.Status}}\\t{{.Ports}}"
                    
                    echo "ğŸ” Container inspection:"
                    docker inspect ${CONTAINER_NAME} --format "{{.State.Status}} - {{.State.Health.Status}} - {{.NetworkSettings.Ports}}"
                    
                    if docker ps --filter "name=${CONTAINER_NAME}" --filter "status=running" | grep -q "${CONTAINER_NAME}"; then
                        echo "ğŸ“ˆ Container resource usage:"
                        docker stats ${CONTAINER_NAME} --no-stream --format "table {{.Container}}\\t{{.CPUPerc}}\\t{{.MemUsage}}\\t{{.NetIO}}"
                        
                        echo "ğŸ“„ Recent container logs:"
                        docker logs ${CONTAINER_NAME} --tail 10
                    fi
                else
                    echo "âŒ Express app container not found"
                fi
            '''
            break
            
        case 'specific':
            if (!specificContainer) {
                error "Specific container name must be provided when CONTAINER_TARGET is 'specific'"
            }
            sh """
                echo "ğŸ“Š Checking status of container: ${specificContainer}"
                
                if docker ps -a --filter "name=${specificContainer}" | grep -q "${specificContainer}"; then
                    echo "ğŸ“‹ Container details:"
                    docker ps -a --filter "name=${specificContainer}" --format "table {{.Names}}\\t{{.Image}}\\t{{.Status}}\\t{{.Ports}}"
                    
                    echo "ğŸ” Container inspection:"
                    docker inspect ${specificContainer} --format "{{.State.Status}} - {{.State.Health.Status}} - {{.NetworkSettings.Ports}}"
                    
                    if docker ps --filter "name=${specificContainer}" --filter "status=running" | grep -q "${specificContainer}"; then
                        echo "ğŸ“ˆ Container resource usage:"
                        docker stats ${specificContainer} --no-stream --format "table {{.Container}}\\t{{.CPUPerc}}\\t{{.MemUsage}}\\t{{.NetIO}}"
                        
                        echo "ğŸ“„ Recent container logs:"
                        docker logs ${specificContainer} --tail 10
                    fi
                else
                    echo "âŒ Container '${specificContainer}' not found"
                fi
            """
            break
            
        default:
            error "Unknown container target: ${containerTarget}"
    }
}
